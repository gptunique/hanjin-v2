<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CJ대한통운 대량조회기 - kkddss Secret - Ver.</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  /* 기본 UI 스타일링 */
  body {
    font-family: 'Malgun Gothic', sans-serif; /* 가독성을 위한 맑은 고딕 */
    background: linear-gradient(135deg, #c8102e, #e63946); /* CJ대한통운 브랜드 컬러(레드) 그라데이션 */
    margin: 0; padding: 0; min-height: 100vh; color: #333;
  }
  .container {
    max-width: 1100px; margin: 20px auto; background: white;
    border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden;
  }
  
  /* 헤더 영역 */
  .header {
    background: #c8102e; color: white; padding: 25px;
    text-align: center; font-size: 26px; font-weight: bold;
  }
  .header small { display: block; font-size: 14px; margin-top: 8px; opacity: 0.9; }

  /* 입력 영역 (Textarea & Button) */
  .input-area { padding: 30px; background: #fff5f5; text-align: center; }
  textarea {
    width: 95%; max-width: 900px; height: 200px;
    border: 2px solid #c8102e; border-radius: 10px; padding: 15px; font-size: 16px;
  }
  .btn {
    margin-top: 15px; padding: 16px 40px; background: #c8102e; color: white;
    border: none; border-radius: 50px; font-size: 18px; cursor: pointer;
    box-shadow: 0 5px 15px rgba(200,16,46,0.4);
  }
  .btn:hover { background: #a00d25; transform: translateY(-2px); }

  /* 결과 테이블 스타일 */
  .result-area { padding: 30px; min-height: 300px; }
  .log {
    text-align: center; padding: 18px; background: #ffe6e6; color: #c8102e;
    font-weight: bold; border-radius: 10px; margin-bottom: 25px; font-size: 18px;
  }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
  th { background: #c8102e; color: white; padding: 15px; }
  td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }

  /* 배송 상태별 뱃지 색상 구분 (직관적인 시각화) */
  .status-done { background: #e8f5e8 !important; color: #1b5e20; font-weight: bold; } /* 완료: 초록 */
  .status-ing { background: #fff8e1 !important; color: #e65100; font-weight: bold; }  /* 진행중: 주황 */
  .status-wait { background: #e1f5fe !important; color: #01579b; } /* 대기: 파랑 */
  .status-fail { background: #ffebee !important; color: #c62828; } /* 실패: 빨강 */

  .detail-btn { background: none; border: none; color: #c8102e; font-weight: bold; cursor: pointer; text-decoration: underline; }

  /* [상세보기 모달 디자인] */
  .detail-box { margin: 30px 0; padding: 25px; background: #fff5f5; border: 2px solid #c8102e; border-radius: 12px; display: none; }
  
  /* [CSS Progress Bar] 배송 단계를 시각적으로 보여주는 막대 그래프 */
  .delivery-step {
    display: flex; justify-content: space-between; margin: 25px 0;
    position: relative; height: 80px; align-items: center;
  }
  /* 회색 배경 라인 */
  .delivery-step::before {
    content: ''; position: absolute; top: 40px; left: 5%; right: 5%;
    height: 6px; background: #ddd; z-index: 1;
  }
  /* 빨간색 진행 라인 (width를 JS 변수 --progress로 제어) */
  .delivery-step::after {
    content: ''; position: absolute; top: 40px; left: 5%;
    height: 6px; background: #c8102e; z-index: 2; width: var(--progress, 0%);
  }
  .step { flex: 1; text-align: center; z-index: 3; }
  .circle {
    width: 50px; height: 50px; border-radius: 50%; background: #ddd;
    color: #666; margin: 0 auto 10px; line-height: 50px; font-weight: bold; font-size: 18px;
  }
  /* 현재 단계 활성화 스타일 */
  .step.on .circle { background: #c8102e; color: white; }
  .step-label { font-size: 13px; color: #444; }

  /* 상세 이력 테이블 */
  .track-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
  .track-table th { background: #c8102e; color: white; }
  .track-table td { padding: 10px; border: 1px solid #ddd; }

  /* 하단 저장 버튼 그룹 */
  .btn-group { text-align: center; margin: 40px 0; }
  .btn-save { padding: 14px 35px; margin: 10px; border: none; border-radius: 50px; color: white; font-size: 16px; cursor: pointer; }
  .csv { background: #43a047; }
  .excel { background: #fb8c00; }
  footer { text-align: center; padding: 20px; color: white; font-size: 12px; }
</style>
</head>

<body>
<div class="container">
  <div class="header">
    CJ대한통운 실시간 대량조회 - kkddss Secret - Ver.
    <small>전 세계 어디서나 접속 · 상세이력 포함 · 엑셀/CSV 저장</small>
  </div>
  
  <div class="input-area">
    <textarea id="numbers" placeholder="송장번호를 한 줄에 하나씩 입력하세요 (최대 500건)&#10;예시:&#10;620679876543&#10;620680123456"></textarea><br>
    <button class="btn" onclick="start()">조회 시작 (강화된 봇 우회)</button>
  </div>
  
  <div class="result-area">
    <div id="log" class="log">송장번호를 입력하고 [조회 시작] 버튼을 눌러주세요</div>
    <div id="result"></div>
  </div>
</div>

<footer>
  CJ대한통운 대량조회 전용 사이트 · 언제 어디서나 무료 사용 가능
</footer>

<script>
/**
 * [핵심 기능 1] 다중 CORS 우회 프록시 함수
 * 여러 프록시 서버를 fallback으로 시도
 */
async function proxy(url) {
  // 사용 가능한 CORS 프록시 목록 (우선순위 순서)
  const proxies = [
    (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
  ];
  
  // 각 프록시를 순차적으로 시도
  for (const proxyFn of proxies) {
    try {
      const response = await fetch(proxyFn(url), {
        headers: {
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
        }
      });
      
      if (response.ok) {
        return await response.text();
      }
    } catch (e) {
      console.log(`Proxy failed, trying next...`, e);
      continue;
    }
  }
  
  throw new Error('All proxies failed');
}

// 조회된 모든 데이터를 저장할 전역 배열 (엑셀 다운로드용)
let allResults = [];

/**
 * [핵심 기능 2] 개별 송장번호 조회 및 파싱 (Web Scraping logic)
 * @param {string} num - 송장번호
 */
async function query(num) {
  // CJ대한통운 실제 조회 URL들 (우선순위 순서)
  const urls = [
    `http://nexs.cjgls.com/web/info.jsp?slipno=${num}`,
    `http://www.doortodoor.co.kr/parcel/doortodoor.do?fsp_action=PARC_ACT_002&fsp_cmd=retrieveInvNoACT&invc_no=${num}`
  ];
  
  for (const url of urls) {
    try {
      // 1. HTML 데이터 가져오기 (프록시 경유)
      const html = await proxy(url);
      
      // 2. DOMParser: 텍스트 형태의 HTML을 DOM 객체로 변환
      const doc = new DOMParser().parseFromString(html, "text/html");

      // 3. 데이터 추출 및 상태 판단 로직
      let status = "조회불가", location = "정보없음", progress = 0;
      const tracks = [];
      
      // CJ대한통운 페이지 파싱
      // 방법 1: nexs.cjgls.com 파싱
      if (url.includes('nexs.cjgls')) {
        // 배송상태 추출
        const statusText = doc.body.textContent || "";
        
        if (statusText.includes('배달완료') || statusText.includes('배송완료')) { 
          status = "배달완료"; location = "고객님 댁"; progress = 100; 
        }
        else if (statusText.includes('배달출발') || statusText.includes('배송출발')) { 
          status = "배달출발"; location = "배송 중"; progress = 90; 
        }
        else if (statusText.includes('간선하차') || statusText.includes('배송터미널')) { 
          status = "배송터미널 도착"; 
          progress = 75;
          // 터미널명 추출 시도
          const locMatch = statusText.match(/([가-힣]+(?:터미널|AMP|HUB|SM))/);
          if (locMatch) location = locMatch[1];
        }
        else if (statusText.includes('간선상차')) { 
          status = "간선상차"; location = "이동 중"; progress = 60; 
        }
        else if (statusText.includes('SM입고') || statusText.includes('터미널입고')) { 
          status = "터미널입고"; location = "터미널"; progress = 50; 
        }
        else if (statusText.includes('집화') || statusText.includes('집하')) { 
          status = "집화처리"; location = "집화 완료"; progress = 30; 
        }
        else if (statusText.includes('접수')) { 
          status = "상품접수"; location = "접수 완료"; progress = 15; 
        }
        
        // 배송이력 테이블 파싱 (일반적인 테이블 구조)
        doc.querySelectorAll("table tr").forEach((tr, idx) => {
          if (idx === 0) return; // 헤더 제외
          const tds = tr.querySelectorAll("td");
          if (tds.length >= 3) {
            const dateTime = tds[0].textContent.trim();
            const [date, time] = dateTime.includes(' ') ? dateTime.split(' ') : [dateTime, ''];
            
            tracks.push({
              date: date,
              time: time,
              place: tds[1].textContent.trim(),
              desc: tds[2].textContent.trim()
            });
          }
        });
      }
      // 방법 2: doortodoor.co.kr 파싱
      else if (url.includes('doortodoor')) {
        const statusText = doc.body.textContent || "";
        
        // 상태 키워드 매칭
        if (statusText.includes('배달완료')) { status = "배달완료"; location = "고객님 댁"; progress = 100; }
        else if (statusText.includes('배달출발')) { status = "배달출발"; location = "배송 중"; progress = 90; }
        else if (statusText.includes('간선하차')) { status = "간선하차"; location = "배송터미널"; progress = 75; }
        else if (statusText.includes('간선상차')) { status = "간선상차"; location = "이동 중"; progress = 60; }
        else if (statusText.includes('SM입고')) { status = "SM입고"; location = "터미널"; progress = 50; }
        else if (statusText.includes('집화')) { status = "집화처리"; location = "집화 완료"; progress = 30; }
        else if (statusText.includes('접수')) { status = "상품접수"; location = "접수 완료"; progress = 15; }
        
        // 테이블 파싱
        doc.querySelectorAll("table tbody tr, table tr").forEach((tr, idx) => {
          const tds = tr.querySelectorAll("td");
          if (tds.length >= 4) {
            tracks.push({
              date: tds[0].textContent.trim(),
              time: tds[1].textContent.trim(),
              place: tds[2].textContent.trim(),
              desc: tds[3].textContent.trim()
            });
          }
        });
      }
      
      // 유효한 데이터가 있으면 반환
      if (status !== "조회불가" || tracks.length > 0) {
        return {status, location, progress, tracks: tracks.slice(0, 20)};
      }
      
    } catch (e) {
      console.error("Query error for URL:", url, e);
      continue; // 다음 URL 시도
    }
  }
  
  // 모든 URL 실패시
  return {status:"조회실패", location:"네트워크 오류", progress:0, tracks:[]};
}

/**
 * [메인 실행 함수] 조회 시작 버튼 클릭 시 실행
 */
async function start() {
  const input = document.getElementById("numbers").value.trim();
  if (!input) return alert("송장번호를 입력해주세요!");
  
  // 줄바꿈(\n) 기준으로 송장번호 분리 및 공백 제거
  const nums = input.split("\n").map(x=>x.trim()).filter(x=>x);
  
  if (nums.length > 500) {
    return alert("최대 500건까지 조회 가능합니다!");
  }
  
  // 결과 테이블 초기화
  document.getElementById("result").innerHTML = `<table id="tbl"><tr><th>순번</th><th>송장번호</th><th>상태</th><th>현재위치</th><th>상세보기</th></tr></table>`;
  document.getElementById("log").innerHTML = `<div class="log">조회 시작중... (0/${nums.length})</div>`;
  
  allResults = []; // 결과 배열 초기화
  const table = document.getElementById("tbl");

  // [Loop] 각 송장번호에 대해 순차적 조회 실행
  for (let i = 0; i < nums.length; i++) {
    // 로그 업데이트
    document.getElementById("log").innerHTML = `<div class="log">조회 중 → ${nums[i]} (${i+1}/${nums.length})</div>`;
    
    // 비동기(await)로 조회 실행 -> 데이터가 올 때까지 기다림
    const res = await query(nums[i]);
    
    // 전체 결과 배열에 저장 (엑셀용)
    allResults.push({
      순번: i+1,
      송장번호: nums[i],
      상태: res.status,
      위치: res.location,
      // 상세이력은 텍스트 형태로 변환하여 저장
      상세이력: res.tracks.map(t=>`${t.date} ${t.time} | ${t.place} | ${t.desc}`).join("\n")
    });

    // 테이블에 행 추가 (실시간 렌더링)
    const row = table.insertRow();
    // 상태에 따라 CSS 클래스(색상) 다르게 적용
    row.className = res.status.includes("완료") ? "status-done" :
                    res.status.includes("출발") || res.status.includes("배송") || res.status.includes("간선") ? "status-ing" :
                    res.status.includes("집화") || res.status.includes("터미널") || res.status.includes("입고") ? "status-ing" : 
                    res.status.includes("실패") ? "status-fail" : "status-wait";
                    
    row.innerHTML = `<td>${i+1}</td><td><strong>${nums[i]}</strong></td><td>${res.status}</td><td>${res.location}</td>
      <td><button class="detail-btn" onclick="showDetail(${i})">상세보기</button></td>`;
    
    // [Bot Detection 회피] 너무 빠르게 요청하면 차단될 수 있으므로 랜덤 딜레이(1초~2초) 부여
    await new Promise(r => setTimeout(r, Math.random() * 1000 + 1000));
  }

  // 완료 처리
  document.getElementById("log").innerHTML = `<div class="log" style="background:#d4edda;color:green;">조회 완료! (${nums.length}건 처리됨)</div>`;
  // 엑셀/CSV 저장 버튼 활성화
  document.getElementById("result").innerHTML += `<div class="btn-group">
    <button class="btn-save csv" onclick="saveCSV()">CSV 저장</button>
    <button class="btn-save excel" onclick="saveExcel()">엑셀 저장 (상세이력 포함)</button>
  </div>`;
}

/**
 * [상세보기 기능] 특정 행의 '상세보기' 클릭 시 호출
 * @param {number} i - allResults 배열의 인덱스
 */
function showDetail(i) {
  // 기존에 열려있는 상세창 제거
  document.querySelectorAll(".detail-box").forEach(d => d.remove());
  
  const d = allResults[i];
  // 진행률 계산 (상태 텍스트 기반)
  const progress = d.상태.includes("완료")?100 : d.상태.includes("출발")?90 : 
                   d.상태.includes("간선하차")||d.상태.includes("도착")?75 : 
                   d.상태.includes("간선상차")?60 :
                   d.상태.includes("집화")||d.상태.includes("입고")?50 : 
                   d.상태.includes("접수")?30 : 15;
  
  // 동적으로 HTML 생성 (진행단계 바 + 이력 테이블)
  const html = `<div class="detail-box" style="display:block">
    <h3>운송장번호: ${d.송장번호} → ${d.상태}</h3>
    <div class="delivery-step" style="--progress:${progress}%">
      <div class="step ${progress>=15?'on':''}"><div class="circle">1</div><div class="step-label">접수</div></div>
      <div class="step ${progress>=30?'on':''}"><div class="circle">2</div><div class="step-label">집하</div></div>
      <div class="step ${progress>=50?'on':''}"><div class="circle">3</div><div class="step-label">터미널입고</div></div>
      <div class="step ${progress>=60?'on':''}"><div class="circle">4</div><div class="step-label">간선상차</div></div>
      <div class="step ${progress>=90?'on':''}"><div class="circle">5</div><div class="step-label">배달출발</div></div>
      <div class="step ${progress>=100?'on':''}"><div class="circle">6</div><div class="step-label">배달완료</div></div>
    </div>
    <table class="track-table"><tr><th>일자</th><th>시간</th><th>위치</th><th>내용</th></tr>
      ${d.상세이력 ? d.상세이력.split("\n").map(l => {
        const parts = l.split(" | ");
        const dateTime = parts[0] || "";
        const [date, time] = dateTime.includes(' ') ? dateTime.split(' ') : [dateTime, ''];
        const place = parts[1] || "";
        const desc = parts[2] || "";
        return `<tr><td>${date}</td><td>${time}</td><td>${place}</td><td style="text-align:left">${desc}</td></tr>`;
      }).join("") : "<tr><td colspan=4>내역 없음</td></tr>"}
    </table>
    <div style="text-align:right;margin-top:15px"><button class="btn" style="padding:10px 25px;font-size:14px" onclick="this.parentElement.parentElement.remove()">닫기</button></div>
  </div>`;
  
  // 결과 테이블 바로 아래에 삽입
  document.getElementById("result").insertAdjacentHTML("beforeend", html);
}

/**
 * [CSV 저장] 라이브러리 없이 순수 JS로 텍스트 파일 생성
 */
function saveCSV() {
  // BOM(\uFEFF) 추가로 한글 깨짐 방지 + CSV 포맷팅
  let csv = "\uFEFF순번,송장번호,상태,위치,상세이력\n" + 
    allResults.map(r => `${r.순번},"${r.송장번호}","${r.상태}","${r.위치}","${r.상세이력.replace(/"/g,'""')}"`).join("\n");
  
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv;charset=utf-8"}));
  a.download = `CJ대한통운_조회결과_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

/**
 * [엑셀 저장] SheetJS 라이브러리 활용
 */
function saveExcel() {
  // JSON 데이터를 워크시트로 변환
  const data = allResults.map(r => ({순번:r.순번, 송장번호:r.송장번호, 상태:r.상태, 현재위치:r.위치, 상세이력:r.상세이력}));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  
  // 엑셀 열 너비(Column Width) 설정
  ws["!cols"] = [{wch:8},{wch:16},{wch:12},{wch:20},{wch:90}];
  
  // 시트 추가 및 파일 쓰기
  XLSX.utils.book_append_sheet(wb, ws, "CJ대한통운");
  XLSX.writeFile(wb, `CJ대한통운_조회결과_${new Date().toISOString().slice(0,10)}.xlsx`);
}
</script>
</body>
</html>
